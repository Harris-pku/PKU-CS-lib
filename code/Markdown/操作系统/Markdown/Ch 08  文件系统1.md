## Ch-08  文件系统

#### 1.  文件系统的基本概念

**文件**是对**磁盘**的抽象

所谓文件是指一组带**标识**（文件名）的、在逻辑上有完整意义的信息项的序列

信息项：构成文件内容的基本单位（单个字节或多个字节），各信息项之间具有顺序关系

文件内容的意义：由**文件建立者**和**使用者**解释



##### 1. 1  文件系统

文件系统：操作系统中统一管理**信息资源**的子系统，管理文件的存储、检索、更新，提供安全可靠的共享和保护手段，并且方便用户使用。

+ 统一管理磁盘空间，实施磁盘空间的分配与回收

+ 实现文件的按名存取

	名字空间 $\to$ 磁盘空间

+ 实现文件信息的共享，并提供数据可靠性和安全保障

+ 向用户提供一个方便使用、维护的接口，并向用户提供有关信息

+ 提高文件系统的性能

+ 提供与 $\rm I/O$ 系统的统一接口



##### 1. 2  文件的分类

按文件性质和用途分类

+ 普通文件：包含了用户的信息，一般为 $\rm ASCII$ 或二进制文件
+ 目录文件：管理文件系统的系统文件
+ 特殊文件：
	+ 字符设备文件：和输入输出有关，用于模仿串行 $\rm I/O$ 设备，例如终端，打印机，网络等
	+ 块设备文件：模仿磁盘
+ 管道文件
+ 套接字



##### 1. 3  文件的逻辑结构

从用户角度看文件，由用户的访问方式确定

**流式文件**：构成文件的基本单位是字符

文件是有逻辑意义、无结构的一串字符的集合

**记录式文件**：文件由若干个记录组成，可以按记录进行读、写、查找等操作

每条记录有其内部结构



##### 1. 4  文件的存取方式

顺序存取（访问）——按字节依次读取

随机访问（访问）——从任意位置读写

​				提供读写位置（当前位置）



##### 1. 5  存储介质与物理块

典型的存储介质：磁盘、$\rm SSD$ 盘、磁带、光盘、$\rm U$ 盘

**物理块**（块、数据块）

+ 将存储设备划分为大小相等的块，统一编号
+ 块是信息存储、传输、分配的基本单位



##### 1. 6  典型的磁盘结构

**数据块**是逻辑存储单元、**扇区**是物理存储单元

块大小不等于扇区大小

任何时刻都只有一个磁头处于活动状态：输入输出数据流以位串形式出现物理地址形式：磁头号（盘面号）、磁道号（柱面号）、扇区号

扇区：标题、数据、$\rm ECC$ 纠错信息



##### 1. 7  磁盘访问

一次访盘请求：

读/写、磁盘地址（设备号，柱面号，磁头号，扇区号），内存地址（源/目）

完成过程由三个动作组成：

**寻道**（时间）：磁头移动定位到指定磁盘

**旋转延迟**（时间）：等待指定扇区从磁头下旋转经过

**数据传输**（时间）：数据在磁盘与内存之间的实际传输



##### 1. 8  文件属性：

**文件控制块  $\rm FCB$**：操作系统为管理文件而设置的数据结构，存放了为管理文件所需的所有有关信息（文件属性或元数据）

常用属性：

文件名、文件号、保护、口令、创建者、当前拥有者、文件地址、文件大小、文件类型、共享计数、创建时间、最后修改时间、最后访问时间、各种标志（只读、隐藏、系统、归档、$\rm ASCII/$二进制、顺序/随机访问、临时文件、锁）



##### 1. 9  文件目录、目录项与目录文件

**文件目录**是**文件控制块**的有序集合

**文件目录**

+ 统一管理每个文件的信息
+ 将所有文件的管理信息组织在一起，即构成文件目录

**目录文件**

+ 将文件目录以**文件**的形式存放在磁盘上
+ 一种特殊类型的文件，其内容由**目录项**组成

**目录项**

+ 构成**文件目录**的基本单元
+ 目录项**可以**是 $\rm FCB$，目录是 $\rm FCB$ 的有序集合

为保证映射的完整性，只允许内核修改目录

应用程序通过系统调用访问目录



路径名（文件名）

+ 绝对路径名：从根目录开始
+ 相对路径名：从当前目录开始

当前目录/工作目录

+ 每个进程一个，可以改变，用于解析文件名，允许用户使用相对路径名代替绝对路径名

目录操作

+ 创建目录、删除目录
+ 读目录、写目录、改名、复制



#### 2.  文件系统的实现

实现文件系统需要考虑：**磁盘**与**内存**中的内容布局



##### 2. 1  相关术语：

+ **磁盘分区**：把一个物理磁盘的存储空间划分为几个相互独立的部分，称为**分区** 
+ **文件卷**：逻辑分区，由一个或多个物理块组成
+ **格式化**：在一个文件卷上建立文件系统的过程，即建立并初始化用于文件分配和磁盘空闲空间管理的**管理数据** 



##### 2. 2  磁盘上的内容

+ 引导区：
	+ 包括了从该卷引导操作系统所需要的信息
	+ 每个卷（分区）一个，通常为第一个扇区

+ 卷（分区）信息
	+ 包括该卷（分区）的块数、块大小、空闲块数量和指针、空闲 $\rm FCB$ 数量和指针

+ 目录结构（目录文件）

+ 用户文件
	+ 物理块：
		+ 信息存储、传输、分配的独立单位
		+ 存储设备划分为大小相等的物理块，统一编号



##### 2. 3  文件的物理结构

文件在**物理介质**上的存放方式，也是系统分配给文件的物理块的位置和顺序

要考虑的问题：

+ 存储效率：外部碎片
+ 读写性能：访问速度



###### 2. 3. 1  连续结构（顺序）

文件的信息存放在若干连续的物理块中

连续结构的优缺点

优点

+ 简单、高效
+ 支持顺序存取和随机存取
+ 所需的磁道寻道次数和寻道时间最少
+ 可以同时读入多个块，检索一个块也很容易

缺点

+ 文件不能动态增长

	预留空间：浪费 或 重新分配和移动

+ 不利于文件内容的插入和删除

+ 外部碎片问题，存储紧缩技术



###### 2. 3. 2  链接结构

一个文件的信息存放在若干**不连续**的物理块中，各块之间通过**指针**连接，前一个物理块指向下一个物理块

优点：

+ 提高了磁盘空间利用率，不存在外部碎片问题
+ 有利于文件内容的插入和删除
+ 有利于文件动态扩充

缺点

+ 存取速度慢，不适于随机存取
+ 可靠性问题，如链接指针出错
+ 更多的寻道次数和寻道时间
+ 链接指针占用一定的空间



###### 2. 3. 3  索引结构

一个文件的信息存放在若干**不连续**物理块中

系统为每个文件建立一个专用数据结构——索引表，并将这些块的块号存放在一个索引表中

一个索引表就是磁盘块地址数组，其中第 $i$ 个条目指向文件的第 $i$ 块

优点：

保持了链接结构的优点，又解决了其缺点

+ 既能顺序存取，又能随机存取
+ 满足了文件动态增长、插入删除的要求
+ 能充分利用磁盘空间

缺点：

+ 较多的寻道次数和寻道时间

+ 索引表本身带来了系统开销

	如：内存、磁盘空间、存取时间



索引表组织：

+ 链接方式
	+ 一个盘块存一个索引表，多个索引表链接起来
+ 多级索引方式
	+ 将文件的索引表（二级索引）的地址放在另一个索引表（一级索引）中
+ 综合模式
	+ 直接索引方式	和	间接索引方式	结合



目录文件的组织方式：

+ 顺序表
+ 散列表
	+ 将目录项组织成一散列表
	+ 根据文件名计算散列值，得到一个指向表中文件的指针（冲突值用链表组织）
	+ 优点：查找速度快
+ $B$ 树或 $B+$ 树



##### 2. 4  文件目录检索

目录检索

用户给出文件名：按文件名查找目录项/$FCB$ 

文件名解析：把逻辑名字转换成物理资源

路径名：

+ 全路径名：从根目录开始
+ 相对路径：从当前目录开始

文件寻址

+ 根据目录项/$FCB$ 中文件物理地址等信息，计算文件中任意记录或字符在存取介质上的地址



##### 2. 5  目录文件的改进

加快目录检索

目录项分解法：把 $FCB$ 分为两部分

+ 符号目录项

	文件名，文件号

+ 基本目录项

	除文件名外所有字段

文件目录改进后减少了访问硬盘的次数，提高了检索进度



##### 2. 6  磁盘空间管理

位图法

有关数据结构

位图

+ 用一串二进制位反映磁盘空间中分配使用情况，每个物理块对应一位，分配的物理块为 $1$，否则为 $0$ 
+ 申请物理块时，可以在位示图中查找为 $1$ 的位，返回对应物理块号
+ 归还时，将对应位转置为 $1$ 

空闲块表

+ 将所有空闲块记录在一个表中，即空闲块表
+ 主要有两项内容：起始块号、块数

空闲块链表

+ 把所有空闲块链成一个链
+ 扩展：**成组链接法** 



##### 2. 7  内存中所需的数据结构（$\rm UNIX$）

系统打开文件表

+ 整个系统一张
+ 放在内存：用于保存已打开文件的 $\rm FCB$ 

用户打开文件表

+ 每个进程一个
+ 进程的 $\rm FCB$ 中记录了用户打开文件表的位置



##### 2. 8  文件操作的实现

创建文件：实质是建立文件的 $\rm FCB$ 

+ 在目录中为新文件建立一个目录项，根据提供的参数及需要填写有关内容
+ 分配必要的存储空间

目的：建立系统与文件的联系



打开文件：

根据文件名在文件目录中检索，并将该文件的目录项（$\rm FCB$）读入内存，建立相应的数据结构，为后续的文件操作做好准备

文件描述符/文件句柄



建立文件

$\rm create$（文件名，访问权限）

1. 检查参数的合法性
2. 申请空目录项，并填写相关内容
3. 为文件申请磁盘块
4. 返回



##### 2. 9  文件共享

**文件共享 **是指一个文件被多个用户或进程使用多用户系统中的文件共享是很必要的

一种实现——文件别名：**硬链接**和**软连接** 

**硬链接** 

+ 利用多个路径名描述同一共享文件，多个目录项指向一个文件

**软链接** 

+ 建立一个特殊类型的文件，通过文件内容与另一个文件连接的例子：“快捷方式”指向其他文件



**软链接** 

又称**符号链接**、**快捷方式** 

建立一种特殊类型的文件，其内容是**要共享的文件路径名** 

只有真正的文件所有者才有指向 $i$ 结点的指针

可以建立任意的别名关系，甚至原文件是在其他计算机上



##### 2. 10  挂载和卸载

**挂载**：将一个文件系统加入到另一个文件系统

用户提供：被挂载的文件系统的根目录/挂载点
